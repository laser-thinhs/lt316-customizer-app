generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DesignJobStatus {
  draft
  approved
  exported
}

enum AssetKind {
  original
  normalized
  preview
}

model ProductProfile {
  id                     String   @id @default(cuid())
  name                   String
  sku                    String   @unique
  diameterMm             Decimal  @db.Decimal(10, 3)
  heightMm               Decimal  @db.Decimal(10, 3)
  engraveZoneWidthMm     Decimal  @db.Decimal(10, 3)
  engraveZoneHeightMm    Decimal  @db.Decimal(10, 3)
  seamReference          String
  toolOutlineSvgPath     String
  defaultSettingsProfile Json
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  designJobs             DesignJob[]
}

model MachineProfile {
  id                String   @id @default(cuid())
  name              String
  laserType         String
  lens              String
  rotaryModeDefault String
  powerDefault      Decimal  @db.Decimal(10, 3)
  speedDefault      Decimal  @db.Decimal(10, 3)
  frequencyDefault  Decimal  @db.Decimal(10, 3)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  designJobs        DesignJob[]
}

model DesignJob {
  id               String          @id @default(cuid())
  orderRef         String?
  productProfileId String
  machineProfileId String
  status           DesignJobStatus @default(draft)
  placementJson    Json
  previewImagePath String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  productProfile ProductProfile @relation(fields: [productProfileId], references: [id], onDelete: Restrict)
  machineProfile MachineProfile @relation(fields: [machineProfileId], references: [id], onDelete: Restrict)
  assets         Asset[]

  @@index([productProfileId])
  @@index([machineProfileId])
  @@index([status])
}

model Asset {
  id          String    @id @default(cuid())
  designJobId String
  kind        AssetKind
  mimeType    String
  filePath    String
  widthPx     Int?
  heightPx    Int?
  createdAt   DateTime  @default(now())

  designJob DesignJob @relation(fields: [designJobId], references: [id], onDelete: Cascade)

  @@index([designJobId])
}
